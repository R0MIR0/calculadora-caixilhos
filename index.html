<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Clientes e Usuários</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }
        .modal-content button {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .modal-content .confirm-button {
            background-color: #ef4444;
            color: white;
            margin-right: 12px;
        }
        .modal-content .confirm-button:hover {
            background-color: #dc2626;
        }
        .modal-content .cancel-button {
            background-color: #cbd5e1;
            color: #333;
        }
        .modal-content .cancel-button:hover {
            background-color: #94a3b8;
        }

        .tab-button.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, setDoc, deleteDoc, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global Firebase variables (will be set after initialization)
        window.db = null;
        window.auth = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Provided by environment

        // Expose Firestore functions globally
        window.fbCollection = collection;
        window.fbQuery = query;
        window.fbWhere = where;
        window.fbGetDocs = getDocs;
        window.fbAddDoc = addDoc;
        window.fbSetDoc = setDoc;
        window.fbDeleteDoc = deleteDoc;
        window.fbOnSnapshot = onSnapshot;
        window.fbDoc = doc; // Added doc

        // Function to initialize Firebase and authenticate
        async function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config not found. Please provide __firebase_config.");
                    showMessage("Erro: Configuração do Firebase não encontrada.", "error");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // Setup auth state listener BEFORE attempting sign-in
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        console.log("Usuário autenticado:", user.uid);
                        window.userId = user.uid; // Set global userId
                        setupFirestoreListeners(); // Start listening to Firestore after auth
                        showMessage('Conectado ao servidor.', 'success');
                    } else {
                        console.log("Usuário não autenticado.");
                        window.userId = crypto.randomUUID(); // Fallback for anonymous
                        showMessage('Não autenticado. Operações serão limitadas ou anónimas.', 'info');
                    }
                });

                // Attempt authentication
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } catch (customTokenError) {
                        console.warn("Erro ao autenticar com token personalizado, tentando autenticação anónima:", customTokenError);
                        // If custom token fails, try anonymous sign-in
                        await signInAnonymously(window.auth);
                    }
                } else {
                    // If no custom token is provided, sign in anonymously
                    await signInAnonymously(window.auth);
                }

            } catch (error) {
                console.error("Erro geral ao inicializar Firebase ou autenticar:", error);
                showMessage(`Erro de conexão: ${error.message}`, 'error');
            }
        }

        // Function to setup Firestore real-time listeners
        function setupFirestoreListeners() {
            // Clients listener
            const clientsCollectionRef = window.fbCollection(window.db, `artifacts/${window.appId}/public/data/clients_collection`);
            window.fbOnSnapshot(clientsCollectionRef, (snapshot) => {
                const clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.allClients = clients; // Store globally for filtering
                filterClients(); // Re-render clients whenever data changes
            }, (error) => {
                console.error("Erro ao obter clientes em tempo real:", error);
                showMessage("Erro ao carregar clientes do servidor.", "error");
            });

            // Users listener
            const usersCollectionRef = window.fbCollection(window.db, `artifacts/${window.appId}/public/data/users_collection`);
            window.fbOnSnapshot(usersCollectionRef, (snapshot) => {
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.allUsers = users; // Store globally for filtering and dropdowns
                populateRepresentantes();
                populateGerentes();
                filterUsers(); // Re-render users whenever data changes
            }, (error) => {
                console.error("Erro ao obter utilizadores em tempo real:", error);
                showMessage("Erro ao carregar utilizadores do servidor.", "error");
            });
        }

        // Initialize Firebase when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</head>
<body>
    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-4xl mx-auto my-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Sistema de Cadastros</h1>

        <!-- Navegação por Abas -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tabClientes" class="tab-button flex-1 py-3 text-center text-gray-600 font-medium hover:text-blue-600 hover:border-blue-600 transition-colors duration-200 active">
                Cadastro de Clientes
            </button>
            <button id="tabUtilizadores" class="tab-button flex-1 py-3 text-center text-gray-600 font-medium hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">
                Cadastro de Utilizadores
            </button>
        </div>

        <div id="messageBox" class="hidden p-3 mb-4 text-sm text-center rounded-lg" role="alert"></div>
        <div id="loadingIndicator" class="hidden p-3 mb-4 text-sm text-center rounded-lg bg-blue-100 text-blue-800">
            <div class="loading-spinner"></div>
            A carregar dados...
        </div>

        <!-- Secção Clientes -->
        <div id="clientsSection" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cadastro de Clientes</h2>
            <form id="clientForm" class="space-y-4 bg-gray-50 p-6 rounded-lg shadow-inner">
                <!-- Informação Corporativa -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="razaoSocial" class="block text-sm font-medium text-gray-700 mb-1">Razão Social</label>
                        <input type="text" id="razaoSocial" name="razaoSocial" placeholder="Razão Social da empresa"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="nomeFantasia" class="block text-sm font-medium text-gray-700 mb-1">Nome Fantasia</label>
                        <input type="text" id="nomeFantasia" name="nomeFantasia" placeholder="Nome fantasia da empresa"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="cnpj" class="block text-sm font-medium text-gray-700 mb-1">NIF</label>
                        <input type="text" id="cnpj" name="cnpj" placeholder="XXXXXXXXX" maxlength="18"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                </div>

                <!-- Campos de Endereço com Preenchimento Automático por CEP -->
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 border-t border-gray-200 pt-4">
                    <div class="md:col-span-2">
                        <label for="cep" class="block text-sm font-medium text-gray-700 mb-1">Código Postal</label>
                        <input type="text" id="cep" name="cep" placeholder="XXXX-XXX" maxlength="9"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-4">
                        <label for="logradouro" class="block text-sm font-medium text-gray-700 mb-1">Morada</label>
                        <input type="text" id="logradouro" name="logradouro" placeholder="Rua, Avenida, etc."
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">Número</label>
                        <input type="text" id="numero" name="numero" placeholder="123"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-4">
                        <label for="bairro" class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
                        <input type="text" id="bairro" name="bairro" placeholder="Bairro"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg" readonly>
                    </div>
                    <div class="md:col-span-4">
                        <label for="cidade" class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                        <input type="text" id="cidade" name="cidade" placeholder="Cidade"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="estado" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                        <input type="text" id="estado" name="estado" placeholder="Distrito" maxlength="2"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg" readonly>
                    </div>
                </div>

                <!-- Informação de Contacto Pessoal -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 pt-4">
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome (Contacto)</label>
                        <input type="text" id="nome" name="nome" placeholder="Nome do contacto" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="telefone" class="block text-sm font-medium text-gray-700 mb-1">Telefone (Contacto)</label>
                        <input type="tel" id="telefone" name="telefone" placeholder="(XX) XXXX-XXXX" maxlength="15"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email (Contacto)</label>
                        <input type="email" id="email" name="email" placeholder="email.contacto@exemplo.com" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label for="representante" class="block text-sm font-medium text-gray-700 mb-1">Representante</label>
                        <select id="representante" name="representante"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                            <option value="">Selecione um Representante (opcional)</option>
                        </select>
                    </div>
                </div>

                <!-- Informação de Reserva -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 pt-4">
                    <div>
                        <label for="reservado" class="inline-flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" id="reservado" name="reservado" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                            <span class="ml-2">Reservado</span>
                        </label>
                    </div>
                    <div id="dataReservaContainer" class="hidden">
                        <label for="dataReserva" class="block text-sm font-medium text-gray-700 mb-1">Data da Reserva</label>
                        <input type="date" id="dataReserva" name="dataReserva"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="submit" id="saveClientButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cadastrar Cliente
                    </button>
                    <button type="button" id="cancelClientEditButton" class="hidden bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cancelar Edição
                    </button>
                </div>
            </form>

            <h2 class="text-2xl font-bold text-gray-800 my-4">Clientes Cadastrados</h2>
            <div class="mb-4">
                <label for="clientSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Pesquisar Clientes</label>
                <input type="text" id="clientSearchInput" placeholder="Pesquisar por razão social, nome, NIF, e-mail, representante..."
                       class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Razão Social</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome Fantasia</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIF</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Morada</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome (Contacto)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email (Contacto)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone (Contacto)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Representante</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reservado</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Reserva</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="clientTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="12" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                Nenhum cliente cadastrado.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Secção Utilizadores -->
        <div id="usersSection" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cadastro de Utilizadores</h2>
            <form id="userForm" class="space-y-4 bg-gray-50 p-6 rounded-lg shadow-inner">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                        <input type="text" id="userName" name="userName" placeholder="Nome do utilizador" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="userPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <input type="tel" id="userPhone" name="userPhone" placeholder="(XX) XXXX-XXXX" maxlength="15"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="userEmail" name="userEmail" placeholder="email.utilizador@exemplo.com" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="userType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Utilizador</label>
                        <select id="userType" name="userType" required
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                            <option value="">Selecione</option>
                            <option value="administrador">Administrador</option>
                            <option value="gerente">Gerente</option>
                            <option value="tecnico">Técnico</option>
                            <option value="orcamentista">Orçamentista</option>
                            <option value="representante">Representante</option>
                        </select>
                    </div>
                    <div>
                        <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="userPassword" name="userPassword" placeholder="••••••••" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="userActive" class="inline-flex items-center text-sm font-medium text-gray-700 cursor-pointer mt-7">
                            <input type="checkbox" id="userActive" name="userActive" class="form-checkbox h-4 w-4 text-blue-600 rounded" checked>
                            <span class="ml-2">Ativo</span>
                        </label>
                    </div>
                    <!-- Campo Gerente, exibido apenas para Representante -->
                    <div id="gerenteContainer" class="hidden md:col-span-2">
                        <label for="userGerente" class="block text-sm font-medium text-gray-700 mb-1">Gerente (apenas para Representante)</label>
                        <select id="userGerente" name="userGerente"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                            <option value="">Selecione um Gerente</option>
                        </select>
                    </div>
                    <!-- Campo Representantes, exibido apenas para Gerente - Agora apenas exibição -->
                    <div id="representantesContainer" class="hidden md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Representantes Associados (para Gerente)</label>
                        <div id="userRepresentantesDisplay" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 min-h-[96px] overflow-y-auto text-gray-700">
                            <!-- Representantes serão listados aqui por JavaScript -->
                            Nenhum representante atribuído.
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="submit" id="saveUserButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cadastrar Utilizador
                    </button>
                    <button type="button" id="cancelUserEditButton" class="hidden bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cancelar Edição
                    </button>
                </div>
            </form>

            <h2 class="text-2xl font-bold text-gray-800 my-4">Utilizadores Cadastrados</h2>
            <div class="mb-4">
                <label for="userSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Pesquisar Utilizadores</label>
                <input type="text" id="userSearchInput" placeholder="Pesquisar por nome, email, tipo..."
                       class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                Nenhum utilizador cadastrado.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Personalizado -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Confirmar Exclusão</h3>
            <p class="mb-4">Tem certeza de que deseja excluir este item?</p>
            <button id="confirmDeleteBtn" class="confirm-button">Excluir</button>
            <button id="cancelDeleteBtn" class="cancel-button">Cancelar</button>
        </div>
    </div>

    <script>
        // CLIENTES - Obter referências aos elementos
        const tabClientes = document.getElementById('tabClientes');
        const tabUtilizadores = document.getElementById('tabUtilizadores');
        const clientsSection = document.getElementById('clientsSection');
        const usersSection = document.getElementById('usersSection');
        const loadingIndicatorApp = document.getElementById('loadingIndicator');

        const clientForm = document.getElementById('clientForm');
        const nomeInput = document.getElementById('nome');
        const razaoSocialInput = document.getElementById('razaoSocial');
        const nomeFantasiaInput = document.getElementById('nomeFantasia');
        const cnpjInput = document.getElementById('cnpj');
        const emailInput = document.getElementById('email');
        const telefoneInput = document.getElementById('telefone');
        const representanteSelect = document.getElementById('representante');
        const reservadoCheckbox = document.getElementById('reservado');
        const dataReservaInput = document.getElementById('dataReserva');
        const dataReservaContainer = document.getElementById('dataReservaContainer');

        const cepInput = document.getElementById('cep');
        const logradouroInput = document.getElementById('logradouro');
        const numeroInput = document.getElementById('numero');
        const bairroInput = document.getElementById('bairro');
        const cidadeInput = document.getElementById('cidade');
        const estadoInput = document.getElementById('estado');
        const saveClientButton = document.getElementById('saveClientButton');
        const cancelClientEditButton = document.getElementById('cancelClientEditButton');
        const clientTableBody = document.getElementById('clientTableBody');
        const clientSearchInput = document.getElementById('clientSearchInput');

        // UTILIZADORES - Obter referências aos elementos
        const userForm = document.getElementById('userForm');
        const userNameInput = document.getElementById('userName');
        const userPhoneInput = document.getElementById('userPhone');
        const userEmailInput = document.getElementById('userEmail');
        const userTypeSelect = document.getElementById('userType');
        const userPasswordInput = document.getElementById('userPassword'); 
        const userActiveCheckbox = document.getElementById('userActive');
        const userGerenteSelect = document.getElementById('userGerente');
        const gerenteContainer = document.getElementById('gerenteContainer');
        const userRepresentantesDisplay = document.getElementById('userRepresentantesDisplay'); 
        const representantesContainer = document.getElementById('representantesContainer');
        const saveUserButton = document.getElementById('saveUserButton');
        const cancelUserEditButton = document.getElementById('cancelUserEditButton');
        const userTableBody = document.getElementById('userTableBody');
        const userSearchInput = document.getElementById('userSearchInput');


        // Elementos comuns
        const messageBoxApp = document.getElementById('messageBox');
        const confirmModal = document.getElementById('confirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        let editingClientId = null;
        let editingUserId = null;
        let itemToDeleteId = null;
        let currentDeleteItemType = null;

        // Global arrays to store data locally after Firestore sync
        window.allClients = [];
        window.allUsers = [];

        // --- Funções Utilitárias Comuns ---
        /**
         * Exibe uma mensagem na caixa de mensagens.
         * @param {string} message - O texto da mensagem.
         * @param {('success'|'error'|'info')} type - O tipo da mensagem (determina a cor).
         */
        function showMessage(message, type) {
            messageBoxApp.textContent = message;
            messageBoxApp.className = `p-3 mb-4 text-sm text-center rounded-lg `;
            messageBoxApp.classList.remove('hidden');

            switch (type) {
                case 'success':
                    messageBoxApp.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    messageBoxApp.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                    messageBoxApp.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                default:
                    messageBoxApp.classList.add('bg-gray-100', 'text-gray-800');
            }

            setTimeout(() => {
                messageBoxApp.classList.add('hidden');
            }, 3000);
        }

        /**
         * Exibe/oculta o indicador de carregamento.
         * @param {boolean} show - Verdadeiro para mostrar, falso para ocultar.
         */
        function showLoading(show) {
            if (show) {
                loadingIndicatorApp.classList.remove('hidden');
            } else {
                loadingIndicatorApp.classList.add('hidden');
            }
        }

        /**
         * Formata NIF para exibição e entrada.
         * @param {string} value - A string NIF bruta.
         * @returns {string} NIF formatado.
         */
        function formatCnpj(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
            return value;
        }

        /**
         * Formata o número de telefone para exibição e entrada.
         * @param {string} value - A string de telefone bruta.
         * @returns {string} Telefone formatado.
         */
        function formatPhone(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            if (value.length > 10) {
                value = value.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (value.length > 5) {
                value = value.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d\d)(\d{0,5})/, '($1) $2');
            } else {
                value = value.replace(/^(\d*)/, '($1');
            }
            return value;
        }

        /**
         * Formata Código Postal para exibição e entrada.
         * @param {string} value - A string Código Postal bruta.
         * @returns {string} Código Postal formatado.
         */
        function formatCep(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            return value;
        }

        /**
         * Exibe o modal de confirmação personalizado.
         * @param {string} id - O ID do item a ser excluído (document ID from Firestore).
         * @param {string} type - O tipo de item ('client' ou 'user').
         */
        window.showConfirmModal = function(id, type) {
            itemToDeleteId = id;
            currentDeleteItemType = type;
            confirmModal.classList.remove('hidden');
        }

        /**
         * Oculta o modal de confirmação personalizado.
         */
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            itemToDeleteId = null;
            currentDeleteItemType = null;
        }

        confirmDeleteBtn.addEventListener('click', async () => {
            if (itemToDeleteId !== null && currentDeleteItemType !== null) {
                showLoading(true);
                try {
                    if (currentDeleteItemType === 'client') {
                        await deleteClient(itemToDeleteId);
                    } else if (currentDeleteItemType === 'user') {
                        await deleteUser(itemToDeleteId);
                    }
                    hideConfirmModal();
                    showMessage(`${currentDeleteItemType === 'client' ? 'Cliente' : 'Utilizador'} excluído com sucesso!`, 'success');
                } catch (error) {
                    console.error(`Erro ao excluir ${currentDeleteItemType}:`, error);
                    showMessage(`Erro ao excluir ${currentDeleteItemType === 'client' ? 'cliente' : 'utilizador'}.`, 'error');
                } finally {
                    showLoading(false);
                }
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            hideConfirmModal();
        });

        // --- Lógica de Troca de Abas ---
        /**
         * Exibe a aba especificada e atualiza os estilos dos botões ativos.
         * @param {string} tabName - O nome da aba a ser exibida ('clients' ou 'users').
         */
        function showTab(tabName) {
            const allTabContents = document.querySelectorAll('.tab-content');
            allTabContents.forEach(content => content.classList.add('hidden'));

            const allTabButtons = document.querySelectorAll('.tab-button');
            allTabButtons.forEach(button => button.classList.remove('active'));

            if (tabName === 'clients') {
                clientsSection.classList.remove('hidden');
                tabClientes.classList.add('active');
                // Data for clients comes from onSnapshot in initFirebase
                populateRepresentantes();
                filterClients();
            } else if (tabName === 'users') {
                usersSection.classList.remove('hidden');
                tabUtilizadores.classList.add('active');
                // Data for users comes from onSnapshot in initFirebase
                populateGerentes();
                toggleUserSpecificFields();
                filterUsers();
            }
        }

        tabClientes.addEventListener('click', () => showTab('clients'));
        tabUtilizadores.addEventListener('click', () => showTab('users'));


        // --- Funções Específicas de Clientes (Firestore) ---
        /**
         * Adiciona ou atualiza um cliente no Firestore.
         * @param {Object} clientData - Os dados do cliente.
         * @param {string|null} docId - O ID do documento se estiver a editar, ou null para um novo.
         */
        async function saveClientToFirestore(clientData, docId = null) {
            showLoading(true);
            try {
                const clientsCollectionRef = window.fbCollection(window.db, `artifacts/${window.appId}/public/data/clients_collection`);
                // This is where the client data is persisted to Firestore.
                if (docId) {
                    await window.fbSetDoc(window.fbDoc(clientsCollectionRef, docId), clientData, { merge: true });
                    showMessage('Cliente atualizado com sucesso!', 'success');
                } else {
                    await window.fbAddDoc(clientsCollectionRef, clientData);
                    showMessage('Cliente cadastrado com sucesso!', 'success');
                }
            } catch (error) {
                console.error("Erro ao salvar cliente no Firestore:", error);
                showMessage(`Erro ao salvar cliente: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Elimina um cliente do Firestore.
         * @param {string} docId - O ID do documento do cliente a eliminar.
         */
        async function deleteClient(docId) {
            showLoading(true);
            try {
                const clientsCollectionRef = window.fbCollection(window.db, `artifacts/${window.appId}/public/data/clients_collection`);
                await window.fbDeleteDoc(window.fbDoc(clientsCollectionRef, docId));
                // UI update is handled by onSnapshot
            } catch (error) {
                console.error("Erro ao eliminar cliente do Firestore:", error);
                throw error; // Re-throw to be caught by the modal's error handling
            } finally {
                showLoading(false);
            }
        }

        /**
         * Alterna a visibilidade do campo "Data da Reserva" com base na caixa de seleção "Reservado".
         * Também define a data atual se a caixa de seleção estiver marcada e o campo estiver vazio.
         */
        function toggleDataReservaField() {
            if (reservadoCheckbox.checked) {
                dataReservaContainer.classList.remove('hidden');
                dataReservaInput.setAttribute('required', 'true');
                if (!dataReservaInput.value) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    dataReservaInput.value = `${year}-${month}-${day}`;
                }
            } else {
                dataReservaContainer.classList.add('hidden');
                dataReservaInput.removeAttribute('required');
                dataReservaInput.value = '';
            }
        }

        /**
         * Renderiza a tabela de clientes com os clientes fornecidos.
         * @param {Array<Object>} clients - Um array de objetos de cliente para exibir.
         */
        function renderClients(clients) {
            clientTableBody.innerHTML = '';
            if (clients.length === 0) {
                const noClientsRow = `
                    <tr>
                        <td colspan="12" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                            Nenhum cliente cadastrado.
                        </td>
                    </tr>
                `;
                clientTableBody.innerHTML = noClientsRow;
                return;
            }

            clients.forEach(client => {
                const row = document.createElement('tr');
                row.id = `client-${client.id}`;
                row.className = 'hover:bg-gray-50';

                const fullAddress = [
                    client.logradouro,
                    client.numero ? `, ${client.numero}` : '',
                    client.bairro ? ` - ${client.bairro}` : '',
                    client.cidade ? ` - ${client.cidade}` : '',
                    client.estado ? `/${client.estado}` : ''
                ].filter(Boolean).join('');

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${client.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.razaoSocial || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.nomeFantasia || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCnpj(client.cnpj || '') || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fullAddress || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatPhone(client.telefone || '') || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.representante || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.reservado ? 'Sim' : 'Não'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.dataReserva ? new Date(client.dataReserva).toLocaleDateString('pt-BR') : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-center space-x-2">
                        <button type="button" onclick="editClient('${client.id}')" class="text-blue-600 hover:text-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 p-2 rounded-full hover:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button type="button" onclick="showConfirmModal('${client.id}', 'client')" class="text-red-600 hover:text-red-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 p-2 rounded-full hover:bg-red-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                clientTableBody.appendChild(row);
            });
        }

        clientForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const nome = nomeInput.value.trim();
            const razaoSocial = razaoSocialInput.value.trim();
            const nomeFantasia = nomeFantasiaInput.value.trim();
            const cnpj = cnpjInput.value.trim();
            const email = emailInput.value.trim();
            const telefone = telefoneInput.value.trim();
            const representante = representanteSelect.value.trim();
            const reservado = reservadoCheckbox.checked;
            const dataReserva = reservado ? dataReservaInput.value : '';

            const cep = cepInput.value.trim();
            const logradouro = logradouroInput.value.trim();
            const numero = numeroInput.value.trim();
            const bairro = bairroInput.value.trim();
            const cidade = cidadeInput.value.trim();
            const estado = estadoInput.value.trim();


            if (!nome || !email) {
                showMessage('Nome e Email de contacto são campos obrigatórios.', 'error');
                return;
            }

            if (reservado && !dataReserva) {
                showMessage('Data da Reserva é obrigatória se o cliente estiver reservado.', 'error');
                return;
            }

            // Check for duplicate email only for new clients or if email is changed during edit
            const emailExists = window.allClients.some(c => c.email === email && c.id !== editingClientId);
            if (emailExists) {
                showMessage('Erro: Este email já está cadastrado para outro cliente.', 'error');
                return;
            }

            const clientData = {
                nome,
                razaoSocial,
                nomeFantasia,
                cnpj: cnpj.replace(/\D/g, ''),
                email,
                telefone: telefone.replace(/\D/g, ''),
                representante,
                reservado,
                dataReserva,
                cep: cep.replace(/\D/g, ''),
                logradouro,
                numero,
                bairro,
                cidade,
                estado
            };

            await saveClientToFirestore(clientData, editingClientId);

            clientForm.reset();
            editingClientId = null;
            saveClientButton.textContent = 'Cadastrar Cliente';
            cancelClientEditButton.classList.add('hidden');
            logradouroInput.readOnly = true;
            bairroInput.readOnly = true;
            cidadeInput.readOnly = true;
            estadoInput.readOnly = true;
            toggleDataReservaField();
        });

        window.editClient = function(id) {
            const clientToEdit = window.allClients.find(client => client.id === id);

            if (clientToEdit) {
                razaoSocialInput.value = clientToEdit.razaoSocial || '';
                nomeFantasiaInput.value = clientToEdit.nomeFantasia || '';
                cnpjInput.value = formatCnpj(clientToEdit.cnpj || '');
                cepInput.value = formatCep(clientToEdit.cep || '');
                logradouroInput.value = clientToEdit.logradouro || '';
                numeroInput.value = clientToEdit.numero || '';
                bairroInput.value = clientToEdit.bairro || '';
                cidadeInput.value = clientToEdit.cidade || '';
                estadoInput.value = clientToEdit.estado || '';
                nomeInput.value = clientToEdit.nome;
                emailInput.value = clientToEdit.email;
                telefoneInput.value = formatPhone(clientToEdit.telefone || '');
                
                populateRepresentantes();
                representanteSelect.value = clientToEdit.representante || '';

                reservadoCheckbox.checked = clientToEdit.reservado || false;
                dataReservaInput.value = clientToEdit.dataReserva || '';

                toggleDataReservaField();

                logradouroInput.readOnly = false;
                bairroInput.readOnly = false;
                cidadeInput.readOnly = false;
                estadoInput.readOnly = false;

                editingClientId = id;
                saveClientButton.textContent = 'Guardar Alterações';
                cancelClientEditButton.classList.remove('hidden');
                showMessage('A editar cliente ID: ' + id, 'info');
            }
        };

        cancelClientEditButton.addEventListener('click', () => {
            clientForm.reset();
            editingClientId = null;
            saveClientButton.textContent = 'Cadastrar Cliente';
            cancelClientEditButton.classList.add('hidden');
            logradouroInput.readOnly = true;
            bairroInput.readOnly = true;
            cidadeInput.readOnly = true;
            estadoInput.readOnly = true;
            toggleDataReservaField();
            showMessage('Edição cancelada.', 'info');
        });

        /**
         * Preenche os campos de endereço com base no Código Postal usando a API ViaCEP.
         * @param {string} cep - O Código Postal a ser pesquisado.
         */
        async function fillAddressByCep(cep) {
            logradouroInput.value = '';
            bairroInput.value = '';
            cidadeInput.value = '';
            estadoInput.value = '';

            logradouroInput.readOnly = false;
            bairroInput.readOnly = false;
            cidadeInput.readOnly = false;
            estadoInput.readOnly = false;

            const cleanedCep = cep.replace(/\D/g, '');
            if (cleanedCep.length !== 8) {
                showMessage('Código Postal inválido. Digite 8 dígitos.', 'error');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cleanedCep}/json/`);
                const data = await response.json();

                if (data.erro) {
                    showMessage('Código Postal não encontrado.', 'error');
                } else {
                    logradouroInput.value = data.logradouro || '';
                    bairroInput.value = data.bairro || '';
                    cidadeInput.value = data.localidade || '';
                    estadoInput.value = data.uf || '';
                    numeroInput.focus();

                    logradouroInput.readOnly = true;
                    bairroInput.readOnly = true;
                    cidadeInput.readOnly = true;
                    estadoInput.readOnly = true;
                }
            } catch (error) {
                console.error('Erro ao buscar Código Postal:', error);
                showMessage('Erro ao buscar Código Postal. Tente novamente.', 'error');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Filtra a lista de clientes com base na entrada de pesquisa.
         */
        function filterClients() {
            const searchTerm = clientSearchInput.value.trim().toLowerCase();
            let clients = window.allClients || [];

            if (searchTerm === '') {
                renderClients(clients);
                return;
            }

            const filteredClients = clients.filter(client => {
                const razaoSocial = (client.razaoSocial || '').toLowerCase();
                const nomeFantasia = (client.nomeFantasia || '').toLowerCase();
                const cnpj = (client.cnpj || '').toLowerCase();
                const nome = (client.nome || '').toLowerCase();
                const email = (client.email || '').toLowerCase();
                const representante = (client.representante || '').toLowerCase();

                return razaoSocial.includes(searchTerm) ||
                       nomeFantasia.includes(searchTerm) ||
                       cnpj.includes(searchTerm.replace(/\D/g, '')) ||
                       nome.includes(searchTerm) ||
                       email.includes(searchTerm) ||
                       representante.includes(searchTerm);
            });

            renderClients(filteredClients);
        }

        cnpjInput.addEventListener('input', (event) => {
            event.target.value = formatCnpj(event.target.value);
        });

        telefoneInput.addEventListener('input', (event) => {
            event.target.value = formatPhone(event.target.value);
        });

        cepInput.addEventListener('input', (event) => {
            event.target.value = formatCep(event.target.value);
        });

        cepInput.addEventListener('blur', () => {
            const cep = cepInput.value.trim();
            if (cep.replace(/\D/g, '').length === 8) {
                fillAddressByCep(cep);
            }
        });

        reservadoCheckbox.addEventListener('change', toggleDataReservaField);
        clientSearchInput.addEventListener('input', filterClients);

        /**
         * Preenche o dropdown 'Representante' com utilizadores ativos do tipo 'representante'.
         */
        function populateRepresentantes() {
            const users = window.allUsers || [];
            const representantes = users.filter(user => user.userType === 'representante' && user.userActive);

            representanteSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione um Representante (opcional)';
            representanteSelect.appendChild(defaultOption);

            representantes.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep.userName;
                option.textContent = rep.userName;
                representanteSelect.appendChild(option);
            });
        }


        // --- Funções Específicas de Utilizadores (Firestore) ---
        /**
         * Adiciona ou atualiza um utilizador no Firestore.
         * @param {Object} userData - Os dados do utilizador.
         * @param {string|null} docId - O ID do documento se estiver a editar, ou null para um novo.
         */
        async function saveUserToFirestore(userData, docId = null) {
            showLoading(true);
            try {
                const usersCollectionRef = window.fbCollection(window.db, `artifacts/${window.appId}/public/data/users_collection`);
                // This is where the user data is persisted to Firestore.
                if (docId) {
                    await window.fbSetDoc(window.fbDoc(usersCollectionRef, docId), userData, { merge: true });
                    showMessage('Utilizador atualizado com sucesso!', 'success');
                } else {
                    await window.fbAddDoc(usersCollectionRef, userData);
                    showMessage('Utilizador cadastrado com sucesso!', 'success');
                }
            } catch (error) {
                console.error("Erro ao salvar utilizador no Firestore:", error);
                showMessage(`Erro ao salvar utilizador: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Elimina um utilizador do Firestore.
         * @param {string} docId - O ID do documento do utilizador a eliminar.
         */
        async function deleteUser(docId) {
            showLoading(true);
            try {
                const usersCollectionRef = window.fbCollection(window.db, `artifacts/${window.appId}/public/data/users_collection`);
                const deletedUser = window.allUsers.find(user => user.id === docId);

                // Delete the user document
                await window.fbDeleteDoc(window.fbDoc(usersCollectionRef, docId));

                // If the deleted user was a manager, clear their name from associated representatives
                if (deletedUser && deletedUser.userType === 'gerente') {
                    const associatedReps = window.allUsers.filter(user =>
                        user.userType === 'representante' && user.userGerente === deletedUser.userName
                    );

                    for (const rep of associatedReps) {
                        await window.fbSetDoc(window.fbDoc(usersCollectionRef, rep.id), { userGerente: '' }, { merge: true });
                    }
                }
                // UI update is handled by onSnapshot
            } catch (error) {
                console.error("Erro ao eliminar utilizador do Firestore:", error);
                throw error; // Re-throw to be caught by the modal's error handling
            } finally {
                showLoading(false);
            }
        }

        /**
         * Alterna a visibilidade dos campos Gerente e Representantes com base no tipo de utilizador selecionado.
         */
        function toggleUserSpecificFields() {
            // Redefine a visibilidade e limpa os valores dos campos específicos
            gerenteContainer.classList.add('hidden');
            userGerenteSelect.removeAttribute('required');
            userGerenteSelect.value = '';

            representantesContainer.classList.add('hidden'); // Oculta o contentor de representantes
            userRepresentantesDisplay.innerHTML = '';
            userRepresentantesDisplay.classList.remove('text-gray-500', 'italic');

            if (userTypeSelect.value === 'representante') {
                gerenteContainer.classList.remove('hidden');
                userGerenteSelect.setAttribute('required', 'true');
                populateGerentes();
            } else if (userTypeSelect.value === 'gerente') {
                // Para o tipo "gerente", o campo de representantes é apenas de exibição na tabela,
                // não é um campo de entrada no formulário.
                // A exibição no formulário será acionada por editUser e updateRepresentativesDisplayForManager.
            }
        }

        /**
         * Preenche o dropdown 'Gerente' com utilizadores ativos do tipo 'gerente'.
         */
        function populateGerentes() {
            const users = window.allUsers || [];
            const gerentes = users.filter(user => user.userType === 'gerente' && user.userActive);

            userGerenteSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione um Gerente';
            userGerenteSelect.appendChild(defaultOption);

            gerentes.forEach(ger => {
                const option = document.createElement('option');
                option.value = ger.userName;
                option.textContent = ger.userName;
                userGerenteSelect.appendChild(option);
            });
        }

        /**
         * Atualiza a área de exibição para representantes atribuídos a um determinado gerente.
         * @param {string} managerName - O nome do gerente para o qual encontrar representantes.
         */
        function updateRepresentativesDisplayForManager(managerName) {
            const users = window.allUsers || [];
            const assignedRepresentatives = users.filter(user =>
                user.userType === 'representante' &&
                user.userActive &&
                user.userGerente === managerName
            ).map(user => user.userName);

            userRepresentantesDisplay.innerHTML = '';
            userRepresentantesDisplay.classList.remove('text-gray-500', 'italic');

            if (assignedRepresentatives.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside text-gray-700';
                assignedRepresentatives.forEach(repName => {
                    const li = document.createElement('li');
                    li.textContent = repName;
                    ul.appendChild(li);
                });
                userRepresentantesDisplay.appendChild(ul);
                representantesContainer.classList.remove('hidden');
            } else {
                userRepresentantesDisplay.textContent = 'Nenhum representante atribuído.';
                userRepresentantesDisplay.classList.add('text-gray-500', 'italic');
                representantesContainer.classList.remove('hidden');
            }
        }

        /**
         * Renderiza a tabela de utilizadores com os utilizadores fornecidos.
         * @param {Array<Object>} users - Um array de objetos de utilizador para exibir.
         */
        function renderUsers(users) {
            userTableBody.innerHTML = '';
            if (users.length === 0) {
                const noUsersRow = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                            Nenhum utilizador cadastrado.
                        </td>
                    </tr>
                `;
                userTableBody.innerHTML = noUsersRow;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.id = `user-${user.id}`;
                row.className = 'hover:bg-gray-50';

                // Determine what to display for 'Gerente' and 'Representantes'
                // These fields are now handled only in the form for specific user types
                // and are not displayed in the main table for all users.
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.userName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.userEmail}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatPhone(user.userPhone || '') || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.userType || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-center space-x-2">
                        <button type="button" onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 p-2 rounded-full hover:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button type="button" onclick="showConfirmModal('${user.id}', 'user')" class="text-red-600 hover:text-red-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 p-2 rounded-full hover:bg-red-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                userTableBody.appendChild(row);
            });
        }

        userForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const userName = userNameInput.value.trim();
            const userEmail = userEmailInput.value.trim();
            const userPhone = userPhoneInput.value.trim();
            const userType = userTypeSelect.value;
            const userPassword = userPasswordInput.value;
            const userActive = userActiveCheckbox.checked;

            let userGerente = '';

            if (userType === 'representante') {
                userGerente = userGerenteSelect.value.trim();
                if (!userGerente) {
                    showMessage('Para Representantes, o campo Gerente é obrigatório.', 'error');
                    return;
                }
            }


            if (!userName || !userEmail || !userType || !userPassword) {
                showMessage('Nome, Email, Tipo de Utilizador e Senha são obrigatórios.', 'error');
                return;
            }

            // Check for duplicate email only for new users or if email is changed during edit
            const emailExists = window.allUsers.some(u => u.userEmail === userEmail && u.id !== editingUserId);
            if (emailExists) {
                showMessage('Erro: Este email já está cadastrado para outro utilizador.', 'error');
                return;
            }

            const userData = {
                userName,
                userEmail,
                userPhone: userPhone.replace(/\D/g, ''),
                userType,
                userPassword: userPassword,
                userActive,
                userGerente: userGerente,
            };

            await saveUserToFirestore(userData, editingUserId);

            userForm.reset();
            editingUserId = null;
            saveUserButton.textContent = 'Cadastrar Utilizador';
            cancelUserEditButton.classList.add('hidden');
            toggleUserSpecificFields();
        });

        window.editUser = function(id) {
            const userToEdit = window.allUsers.find(user => user.id === id);

            if (userToEdit) {
                userNameInput.value = userToEdit.userName || '';
                userEmailInput.value = userToEdit.userEmail || '';
                userPhoneInput.value = formatPhone(userToEdit.userPhone || '');
                userTypeSelect.value = userToEdit.userType || '';
                userPasswordInput.value = userToEdit.userPassword || '';
                userActiveCheckbox.checked = userToEdit.userActive || false;
                
                populateGerentes();
                toggleUserSpecificFields();

                if (userToEdit.userType === 'representante') {
                    userGerenteSelect.value = userToEdit.userGerente || '';
                } else if (userToEdit.userType === 'gerente') {
                    updateRepresentativesDisplayForManager(userToEdit.userName);
                }
                
                editingUserId = id;
                saveUserButton.textContent = 'Guardar Alterações';
                cancelUserEditButton.classList.remove('hidden');
                showMessage('A editar utilizador ID: ' + id, 'info');
            }
        };

        cancelUserEditButton.addEventListener('click', () => {
            userForm.reset();
            editingUserId = null;
            saveUserButton.textContent = 'Cadastrar Utilizador';
            cancelUserEditButton.classList.add('hidden');
            showMessage('Edição de utilizador cancelada.', 'info');
            toggleUserSpecificFields();
        });

        userPhoneInput.addEventListener('input', (event) => {
            event.target.value = formatPhone(event.target.value);
        });

        function filterUsers() {
            const searchTerm = userSearchInput.value.trim().toLowerCase();
            let users = window.allUsers || [];

            if (searchTerm === '') {
                renderUsers(users);
                return;
            }

            const filteredUsers = users.filter(user => {
                const userName = (user.userName || '').toLowerCase();
                const userEmail = (user.userEmail || '').toLowerCase();
                const userPhone = (user.userPhone || '').toLowerCase();
                const userType = (user.userType || '').toLowerCase();
                const userGerente = (user.userGerente || '').toLowerCase();
                
                let userRepresentantesString = '';
                if (user.userType === 'gerente') {
                    const allUsers = window.allUsers || [];
                    const userRepresentantesList = allUsers.filter(rep =>
                        rep.userType === 'representante' &&
                        rep.userGerente === user.userName
                    ).map(rep => rep.userName.toLowerCase());
                    userRepresentantesString = userRepresentantesList.join(', ');
                }


                return userName.includes(searchTerm) ||
                       userEmail.includes(searchTerm) ||
                       userPhone.includes(searchTerm.replace(/\D/g, '')) ||
                       userType.includes(searchTerm) ||
                       userGerente.includes(searchTerm) ||
                       userRepresentantesString.includes(searchTerm);
            });

            renderUsers(filteredUsers);
        }

        userSearchInput.addEventListener('input', filterUsers);
        userTypeSelect.addEventListener('change', toggleUserSpecificFields);


        // Carregamento inicial e exibição de abas
        document.addEventListener('DOMContentLoaded', () => {
            showTab('clients');
            filterClients();
            filterUsers();
            toggleDataReservaField();
            // toggleUserSpecificFields() é chamado por showTab('users') para a secção de utilizadores
        });
    </script>
</body>
</html>
