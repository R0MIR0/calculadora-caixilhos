<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Clientes e Usuários</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }
        .modal-content button {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .modal-content .confirm-button {
            background-color: #ef4444;
            color: white;
            margin-right: 12px;
        }
        .modal-content .confirm-button:hover {
            background-color: #dc2626;
        }
        .modal-content .cancel-button {
            background-color: #cbd5e1;
            color: #333;
        }
        .modal-content .cancel-button:hover {
            background-color: #94a3b8;
        }

        .tab-button.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-4xl mx-auto my-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Sistema de Cadastros</h1>

        <!-- Navegação por Abas -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tabClientes" class="tab-button flex-1 py-3 text-center text-gray-600 font-medium hover:text-blue-600 hover:border-blue-600 transition-colors duration-200 active">
                Cadastro de Clientes
            </button>
            <button id="tabUtilizadores" class="tab-button flex-1 py-3 text-center text-gray-600 font-medium hover:text-blue-600 hover:border-blue-600 transition-colors duration-200">
                Cadastro de Utilizadores
            </button>
        </div>

        <div id="messageBox" class="hidden p-3 mb-4 text-sm text-center rounded-lg" role="alert"></div>

        <!-- Secção Clientes -->
        <div id="clientsSection" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cadastro de Clientes</h2>
            <form id="clientForm" class="space-y-4 bg-gray-50 p-6 rounded-lg shadow-inner">
                <!-- Informação Corporativa -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="razaoSocial" class="block text-sm font-medium text-gray-700 mb-1">Razão Social</label>
                        <input type="text" id="razaoSocial" name="razaoSocial" placeholder="Razão Social da empresa"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="nomeFantasia" class="block text-sm font-medium text-gray-700 mb-1">Nome Fantasia</label>
                        <input type="text" id="nomeFantasia" name="nomeFantasia" placeholder="Nome fantasia da empresa"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="cnpj" class="block text-sm font-medium text-gray-700 mb-1">NIF</label>
                        <input type="text" id="cnpj" name="cnpj" placeholder="XXXXXXXXX" maxlength="18"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                </div>

                <!-- Campos de Endereço com Preenchimento Automático por CEP -->
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 border-t border-gray-200 pt-4">
                    <div class="md:col-span-2">
                        <label for="cep" class="block text-sm font-medium text-gray-700 mb-1">Código Postal</label>
                        <input type="text" id="cep" name="cep" placeholder="XXXX-XXX" maxlength="9"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-4">
                        <label for="logradouro" class="block text-sm font-medium text-gray-700 mb-1">Morada</label>
                        <input type="text" id="logradouro" name="logradouro" placeholder="Rua, Avenida, etc."
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">Número</label>
                        <input type="text" id="numero" name="numero" placeholder="123"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-4">
                        <label for="bairro" class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
                        <input type="text" id="bairro" name="bairro" placeholder="Bairro"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg" readonly>
                    </div>
                    <div class="md:col-span-4">
                        <label for="cidade" class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                        <input type="text" id="cidade" name="cidade" placeholder="Cidade"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label for="estado" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                        <input type="text" id="estado" name="estado" placeholder="Distrito" maxlength="2"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg" readonly>
                    </div>
                </div>

                <!-- Informação de Contacto Pessoal -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 pt-4">
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome (Contacto)</label>
                        <input type="text" id="nome" name="nome" placeholder="Nome do contacto" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="telefone" class="block text-sm font-medium text-gray-700 mb-1">Telefone (Contacto)</label>
                        <input type="tel" id="telefone" name="telefone" placeholder="(XX) XXXX-XXXX" maxlength="15"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email (Contacto)</label>
                        <input type="email" id="email" name="email" placeholder="email.contacto@exemplo.com" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label for="representante" class="block text-sm font-medium text-gray-700 mb-1">Representante</label>
                        <select id="representante" name="representante"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                            <option value="">Selecione um Representante (opcional)</option>
                        </select>
                    </div>
                </div>

                <!-- Informação de Reserva -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 pt-4">
                    <div>
                        <label for="reservado" class="inline-flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" id="reservado" name="reservado" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                            <span class="ml-2">Reservado</span>
                        </label>
                    </div>
                    <div id="dataReservaContainer" class="hidden">
                        <label for="dataReserva" class="block text-sm font-medium text-gray-700 mb-1">Data da Reserva</label>
                        <input type="date" id="dataReserva" name="dataReserva"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="submit" id="saveClientButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cadastrar Cliente
                    </button>
                    <button type="button" id="cancelClientEditButton" class="hidden bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cancelar Edição
                    </button>
                </div>
            </form>

            <h2 class="text-2xl font-bold text-gray-800 my-4">Clientes Cadastrados</h2>
            <div class="mb-4">
                <label for="clientSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Pesquisar Clientes</label>
                <input type="text" id="clientSearchInput" placeholder="Pesquisar por razão social, nome, NIF, e-mail, representante..."
                       class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Razão Social</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome Fantasia</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIF</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Morada</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome (Contacto)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email (Contacto)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone (Contacto)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Representante</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reservado</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Reserva</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="clientTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="12" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                Nenhum cliente cadastrado.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Secção Utilizadores -->
        <div id="usersSection" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cadastro de Utilizadores</h2>
            <form id="userForm" class="space-y-4 bg-gray-50 p-6 rounded-lg shadow-inner">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                        <input type="text" id="userName" name="userName" placeholder="Nome do utilizador" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="userPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <input type="tel" id="userPhone" name="userPhone" placeholder="(XX) XXXX-XXXX" maxlength="15"
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="userEmail" name="userEmail" placeholder="email.utilizador@exemplo.com" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="userType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Utilizador</label>
                        <select id="userType" name="userType" required
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                            <option value="">Selecione</option>
                            <option value="administrador">Administrador</option>
                            <option value="gerente">Gerente</option>
                            <option value="tecnico">Técnico</option>
                            <option value="orcamentista">Orçamentista</option>
                            <option value="representante">Representante</option>
                        </select>
                    </div>
                    <div>
                        <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="userPassword" name="userPassword" placeholder="••••••••" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                    </div>
                    <div>
                        <label for="userActive" class="inline-flex items-center text-sm font-medium text-gray-700 cursor-pointer mt-7">
                            <input type="checkbox" id="userActive" name="userActive" class="form-checkbox h-4 w-4 text-blue-600 rounded" checked>
                            <span class="ml-2">Ativo</span>
                        </label>
                    </div>
                    <!-- Campo Gerente, exibido apenas para Representante -->
                    <div id="gerenteContainer" class="hidden md:col-span-2">
                        <label for="userGerente" class="block text-sm font-medium text-gray-700 mb-1">Gerente (apenas para Representante)</label>
                        <select id="userGerente" name="userGerente"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                            <option value="">Selecione um Gerente</option>
                        </select>
                    </div>
                    <!-- Campo Representantes, exibido apenas para Gerente - Agora apenas exibição -->
                    <div id="representantesContainer" class="hidden md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Representantes Associados (para Gerente)</label>
                        <div id="userRepresentantesDisplay" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 min-h-[96px] overflow-y-auto text-gray-700">
                            <!-- Representantes serão listados aqui por JavaScript -->
                            Nenhum representante atribuído.
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="submit" id="saveUserButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cadastrar Utilizador
                    </button>
                    <button type="button" id="cancelUserEditButton" class="hidden bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cancelar Edição
                    </button>
                </div>
            </form>

            <h2 class="text-2xl font-bold text-gray-800 my-4">Utilizadores Cadastrados</h2>
            <div class="mb-4">
                <label for="userSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Pesquisar Utilizadores</label>
                <input type="text" id="userSearchInput" placeholder="Pesquisar por nome, email, tipo..."
                       class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gerente</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Representantes</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="9" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                Nenhum utilizador cadastrado.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Personalizado -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Confirmar Exclusão</h3>
            <p class="mb-4">Tem certeza de que deseja excluir este item?</p>
            <button id="confirmDeleteBtn" class="confirm-button">Excluir</button>
            <button id="cancelDeleteBtn" class="cancel-button">Cancelar</button>
        </div>
    </div>

    <script>
        // CLIENTES - Obter referências aos elementos
        const tabClientes = document.getElementById('tabClientes');
        const tabUtilizadores = document.getElementById('tabUtilizadores');
        const clientsSection = document.getElementById('clientsSection');
        const usersSection = document.getElementById('usersSection');

        const clientForm = document.getElementById('clientForm');
        const nomeInput = document.getElementById('nome');
        const razaoSocialInput = document.getElementById('razaoSocial');
        const nomeFantasiaInput = document.getElementById('nomeFantasia');
        const cnpjInput = document.getElementById('cnpj');
        const emailInput = document.getElementById('email');
        const telefoneInput = document.getElementById('telefone');
        const representanteSelect = document.getElementById('representante');
        const reservadoCheckbox = document.getElementById('reservado');
        const dataReservaInput = document.getElementById('dataReserva');
        const dataReservaContainer = document.getElementById('dataReservaContainer');

        const cepInput = document.getElementById('cep');
        const logradouroInput = document.getElementById('logradouro');
        const numeroInput = document.getElementById('numero');
        const bairroInput = document.getElementById('bairro');
        const cidadeInput = document.getElementById('cidade');
        const estadoInput = document.getElementById('estado');
        const saveClientButton = document.getElementById('saveClientButton');
        const cancelClientEditButton = document.getElementById('cancelClientEditButton');
        const clientTableBody = document.getElementById('clientTableBody');
        const clientSearchInput = document.getElementById('clientSearchInput');

        // UTILIZADORES - Obter referências aos elementos
        const userForm = document.getElementById('userForm');
        const userNameInput = document.getElementById('userName');
        const userPhoneInput = document.getElementById('userPhone');
        const userEmailInput = document.getElementById('userEmail');
        const userTypeSelect = document.getElementById('userType');
        const userPasswordInput = document.getElementById('userPassword'); 
        const userActiveCheckbox = document.getElementById('userActive');
        const userGerenteSelect = document.getElementById('userGerente');
        const gerenteContainer = document.getElementById('gerenteContainer');
        const userRepresentantesDisplay = document.getElementById('userRepresentantesDisplay'); 
        const representantesContainer = document.getElementById('representantesContainer');
        const saveUserButton = document.getElementById('saveUserButton');
        const cancelUserEditButton = document.getElementById('cancelUserEditButton');
        const userTableBody = document.getElementById('userTableBody');
        const userSearchInput = document.getElementById('userSearchInput');


        // Elementos comuns
        const messageBox = document.getElementById('messageBox');
        const confirmModal = document.getElementById('confirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        let editingClientId = null;
        let editingUserId = null;
        let itemToDeleteId = null;
        let currentDeleteItemType = null;

        // --- Funções Utilitárias Comuns ---
        /**
         * Exibe uma mensagem na caixa de mensagens.
         * @param {string} message - O texto da mensagem.
         * @param {('success'|'error'|'info')} type - O tipo da mensagem (determina a cor).
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `p-3 mb-4 text-sm text-center rounded-lg `;
            messageBox.classList.remove('hidden');

            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                default:
                    messageBox.classList.add('bg-gray-100', 'text-gray-800');
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Formata NIF para exibição e entrada.
         * @param {string} value - A string NIF bruta.
         * @returns {string} NIF formatado.
         */
        function formatCnpj(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
            return value;
        }

        /**
         * Formata o número de telefone para exibição e entrada.
         * @param {string} value - A string de telefone bruta.
         * @returns {string} Telefone formatado.
         */
        function formatPhone(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            if (value.length > 10) {
                value = value.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (value.length > 5) {
                value = value.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d\d)(\d{0,5})/, '($1) $2');
            } else {
                value = value.replace(/^(\d*)/, '($1');
            }
            return value;
        }

        /**
         * Formata Código Postal para exibição e entrada.
         * @param {string} value - A string Código Postal bruta.
         * @returns {string} Código Postal formatado.
         */
        function formatCep(value) {
            if (!value) return '';
            value = value.replace(/\D/g, '');
            value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            return value;
        }

        /**
         * Exibe o modal de confirmação personalizado.
         * @param {number} id - O ID do item a ser excluído.
         * @param {string} type - O tipo de item ('client' ou 'user').
         */
        function showConfirmModal(id, type) {
            itemToDeleteId = id;
            currentDeleteItemType = type;
            confirmModal.classList.remove('hidden');
        }

        /**
         * Oculta o modal de confirmação personalizado.
         */
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            itemToDeleteId = null;
            currentDeleteItemType = null;
        }

        confirmDeleteBtn.addEventListener('click', () => {
            if (itemToDeleteId !== null && currentDeleteItemType !== null) {
                if (currentDeleteItemType === 'client') {
                    deleteClient(itemToDeleteId);
                } else if (currentDeleteItemType === 'user') {
                    deleteUser(itemToDeleteId);
                }
                hideConfirmModal();
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            hideConfirmModal();
        });

        // --- Lógica de Troca de Abas ---
        /**
         * Exibe a aba especificada e atualiza os estilos dos botões ativos.
         * @param {string} tabName - O nome da aba a ser exibida ('clients' ou 'users').
         */
        function showTab(tabName) {
            const allTabContents = document.querySelectorAll('.tab-content');
            allTabContents.forEach(content => content.classList.add('hidden'));

            const allTabButtons = document.querySelectorAll('.tab-button');
            allTabButtons.forEach(button => button.classList.remove('active'));

            if (tabName === 'clients') {
                clientsSection.classList.remove('hidden');
                tabClientes.classList.add('active');
                populateRepresentantes();
                filterClients();
            } else if (tabName === 'users') {
                usersSection.classList.remove('hidden');
                tabUtilizadores.classList.add('active'); // Corrigido para tabUtilizadores
                populateGerentes();
                toggleUserSpecificFields();
                filterUsers();
            }
        }

        tabClientes.addEventListener('click', () => showTab('clients'));
        tabUtilizadores.addEventListener('click', () => showTab('users')); // Corrigido para tabUtilizadores


        // --- Funções Específicas de Clientes ---
        /**
         * Carrega clientes do localStorage.
         * @returns {Array<Object>} Um array de objetos de cliente.
         */
        function loadClients() {
            try {
                const clientsJson = localStorage.getItem('clients');
                return clientsJson ? JSON.parse(clientsJson) : [];
            } catch (e) {
                console.error("Erro ao carregar clientes do localStorage:", e);
                return [];
            }
        }

        /**
         * Salva clientes no localStorage.
         * @param {Array<Object>} clients - Um array de objetos de cliente a ser salvo.
         */
        function saveClients(clients) {
            try {
                localStorage.setItem('clients', JSON.stringify(clients));
            } catch (e) {
                console.error("Erro ao salvar clientes no localStorage:", e);
                showMessage("Erro ao salvar dados no navegador.", "error");
            }
        }

        /**
         * Alterna a visibilidade do campo "Data da Reserva" com base na caixa de seleção "Reservado".
         * Também define a data atual se a caixa de seleção estiver marcada e o campo estiver vazio.
         */
        function toggleDataReservaField() {
            if (reservadoCheckbox.checked) {
                dataReservaContainer.classList.remove('hidden');
                dataReservaInput.setAttribute('required', 'true');
                if (!dataReservaInput.value) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    dataReservaInput.value = `${year}-${month}-${day}`;
                }
            } else {
                dataReservaContainer.classList.add('hidden');
                dataReservaInput.removeAttribute('required');
                dataReservaInput.value = '';
            }
        }

        /**
         * Renderiza a tabela de clientes com os clientes fornecidos.
         * @param {Array<Object>} clients - Um array de objetos de cliente para exibir.
         */
        function renderClients(clients) {
            clientTableBody.innerHTML = '';
            if (clients.length === 0) {
                const noClientsRow = `
                    <tr>
                        <td colspan="12" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                            Nenhum cliente cadastrado.
                        </td>
                    </tr>
                `;
                clientTableBody.innerHTML = noClientsRow;
                return;
            }

            clients.forEach(client => {
                const row = document.createElement('tr');
                row.id = `client-${client.id}`;
                row.className = 'hover:bg-gray-50';

                const fullAddress = [
                    client.logradouro,
                    client.numero ? `, ${client.numero}` : '',
                    client.bairro ? ` - ${client.bairro}` : '',
                    client.cidade ? ` - ${client.cidade}` : '',
                    client.estado ? `/${client.estado}` : ''
                ].filter(Boolean).join('');

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${client.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.razaoSocial || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.nomeFantasia || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCnpj(client.cnpj || '') || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fullAddress || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatPhone(client.telefone || '') || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.representante || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.reservado ? 'Sim' : 'Não'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.dataReserva ? new Date(client.dataReserva).toLocaleDateString('pt-BR') : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-center space-x-2">
                        <button type="button" onclick="editClient(${client.id})" class="text-blue-600 hover:text-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 p-2 rounded-full hover:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button type="button" onclick="showConfirmModal(${client.id}, 'client')" class="text-red-600 hover:text-red-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 p-2 rounded-full hover:bg-red-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                clientTableBody.appendChild(row);
            });
        }

        clientForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const nome = nomeInput.value.trim();
            const razaoSocial = razaoSocialInput.value.trim();
            const nomeFantasia = nomeFantasiaInput.value.trim();
            const cnpj = cnpjInput.value.trim();
            const email = emailInput.value.trim();
            const telefone = telefoneInput.value.trim();
            const representante = representanteSelect.value.trim();
            const reservado = reservadoCheckbox.checked;
            const dataReserva = reservado ? dataReservaInput.value : '';

            const cep = cepInput.value.trim();
            const logradouro = logradouroInput.value.trim();
            const numero = numeroInput.value.trim();
            const bairro = bairroInput.value.trim();
            const cidade = cidadeInput.value.trim();
            const estado = estadoInput.value.trim();


            if (!nome || !email) {
                showMessage('Nome e Email de contacto são campos obrigatórios.', 'error');
                return;
            }

            if (reservado && !dataReserva) {
                showMessage('Data da Reserva é obrigatória se o cliente estiver reservado.', 'error');
                return;
            }

            let clients = loadClients();

            if (editingClientId !== null) {
                const clientIndex = clients.findIndex(c => c.id === editingClientId);
                if (clientIndex > -1) {
                    const emailExists = clients.some(c => c.email === email && c.id !== editingClientId);
                    if (emailExists) {
                        showMessage('Erro: Este email já está cadastrado para outro cliente.', 'error');
                        return;
                    }

                    clients[clientIndex] = {
                        ...clients[clientIndex],
                        nome,
                        razaoSocial,
                        nomeFantasia,
                        cnpj: cnpj.replace(/\D/g, ''),
                        email,
                        telefone: telefone.replace(/\D/g, ''),
                        representante,
                        reservado,
                        dataReserva,
                        cep: cep.replace(/\D/g, ''),
                        logradouro,
                        numero,
                        bairro,
                        cidade,
                        estado
                    };
                    showMessage('Cliente atualizado com sucesso!', 'success');
                }
            } else {
                const emailExists = clients.some(c => c.email === email);
                if (emailExists) {
                    showMessage('Erro: Este email já está cadastrado.', 'error');
                    return;
                }

                const newId = clients.length > 0 ? Math.max(...clients.map(c => c.id)) + 1 : 1;
                const newClient = {
                    id: newId,
                    nome,
                    razaoSocial,
                    nomeFantasia,
                    cnpj: cnpj.replace(/\D/g, ''),
                    email,
                    telefone: telefone.replace(/\D/g, ''),
                    representante,
                    reservado,
                    dataReserva,
                    cep: cep.replace(/\D/g, ''),
                    logradouro,
                    numero,
                    bairro,
                    cidade,
                    estado
                };
                clients.push(newClient);
                showMessage('Cliente cadastrado com sucesso!', 'success');
            }

            saveClients(clients);
            filterClients();
            clientForm.reset();
            editingClientId = null;
            saveClientButton.textContent = 'Cadastrar Cliente';
            cancelClientEditButton.classList.add('hidden');
            logradouroInput.readOnly = true;
            bairroInput.readOnly = true;
            cidadeInput.readOnly = true;
            estadoInput.readOnly = true;
            toggleDataReservaField();
        });

        window.editClient = function(id) {
            const clients = loadClients();
            const clientToEdit = clients.find(client => client.id === id);

            if (clientToEdit) {
                razaoSocialInput.value = clientToEdit.razaoSocial || '';
                nomeFantasiaInput.value = clientToEdit.nomeFantasia || '';
                cnpjInput.value = formatCnpj(clientToEdit.cnpj || '');
                cepInput.value = formatCep(clientToEdit.cep || '');
                logradouroInput.value = clientToEdit.logradouro || '';
                numeroInput.value = clientToEdit.numero || '';
                bairroInput.value = clientToEdit.bairro || '';
                cidadeInput.value = clientToEdit.cidade || '';
                estadoInput.value = clientToEdit.estado || '';
                nomeInput.value = clientToEdit.nome;
                emailInput.value = clientToEdit.email;
                telefoneInput.value = formatPhone(clientToEdit.telefone || '');
                
                populateRepresentantes();
                representanteSelect.value = clientToEdit.representante || '';

                reservadoCheckbox.checked = clientToEdit.reservado || false;
                dataReservaInput.value = clientToEdit.dataReserva || '';

                toggleDataReservaField();

                logradouroInput.readOnly = false;
                bairroInput.readOnly = false;
                cidadeInput.readOnly = false;
                estadoInput.readOnly = false;

                editingClientId = id;
                saveClientButton.textContent = 'Guardar Alterações';
                cancelClientEditButton.classList.remove('hidden');
                showMessage('A editar cliente ID: ' + id, 'info');
            }
        };

        function deleteClient(id) {
            let clients = loadClients();
            clients = clients.filter(client => client.id !== id);
            saveClients(clients);
            filterClients();
            showMessage('Cliente excluído com sucesso!', 'success');
            if (editingClientId === id) {
                clientForm.reset();
                editingClientId = null;
                saveClientButton.textContent = 'Cadastrar Cliente';
                cancelClientEditButton.classList.add('hidden');
                toggleDataReservaField();
            }
        }

        cancelClientEditButton.addEventListener('click', () => {
            clientForm.reset();
            editingClientId = null;
            saveClientButton.textContent = 'Cadastrar Cliente';
            cancelClientEditButton.classList.add('hidden');
            logradouroInput.readOnly = true;
            bairroInput.readOnly = true;
            cidadeInput.readOnly = true;
            estadoInput.readOnly = true;
            toggleDataReservaField();
            showMessage('Edição cancelada.', 'info');
        });

        /**
         * Preenche os campos de endereço com base no Código Postal usando a API ViaCEP.
         * @param {string} cep - O Código Postal a ser pesquisado.
         */
        async function fillAddressByCep(cep) {
            logradouroInput.value = '';
            bairroInput.value = '';
            cidadeInput.value = '';
            estadoInput.value = '';

            logradouroInput.readOnly = false;
            bairroInput.readOnly = false;
            cidadeInput.readOnly = false;
            estadoInput.readOnly = false;

            const cleanedCep = cep.replace(/\D/g, '');
            if (cleanedCep.length !== 8) {
                showMessage('Código Postal inválido. Digite 8 dígitos.', 'error');
                return;
            }

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cleanedCep}/json/`);
                const data = await response.json();

                if (data.erro) {
                    showMessage('Código Postal não encontrado.', 'error');
                } else {
                    logradouroInput.value = data.logradouro || '';
                    bairroInput.value = data.bairro || '';
                    cidadeInput.value = data.localidade || '';
                    estadoInput.value = data.uf || '';
                    numeroInput.focus();

                    logradouroInput.readOnly = true;
                    bairroInput.readOnly = true;
                    cidadeInput.readOnly = true;
                    estadoInput.readOnly = true;
                }
            } catch (error) {
                console.error('Erro ao buscar Código Postal:', error);
                showMessage('Erro ao buscar Código Postal. Tente novamente.', 'error');
            }
        }

        /**
         * Filtra a lista de clientes com base na entrada de pesquisa.
         */
        function filterClients() {
            const searchTerm = clientSearchInput.value.trim().toLowerCase();
            let clients = loadClients();

            if (searchTerm === '') {
                renderClients(clients);
                return;
            }

            const filteredClients = clients.filter(client => {
                const razaoSocial = (client.razaoSocial || '').toLowerCase();
                const nomeFantasia = (client.nomeFantasia || '').toLowerCase();
                const cnpj = (client.cnpj || '').toLowerCase();
                const nome = (client.nome || '').toLowerCase();
                const email = (client.email || '').toLowerCase();
                const representante = (client.representante || '').toLowerCase();

                return razaoSocial.includes(searchTerm) ||
                       nomeFantasia.includes(searchTerm) ||
                       cnpj.includes(searchTerm.replace(/\D/g, '')) ||
                       nome.includes(searchTerm) ||
                       email.includes(searchTerm) ||
                       representante.includes(searchTerm);
            });

            renderClients(filteredClients);
        }

        cnpjInput.addEventListener('input', (event) => {
            event.target.value = formatCnpj(event.target.value);
        });

        telefoneInput.addEventListener('input', (event) => {
            event.target.value = formatPhone(event.target.value);
        });

        cepInput.addEventListener('input', (event) => {
            event.target.value = formatCep(event.target.value);
        });

        cepInput.addEventListener('blur', () => {
            const cep = cepInput.value.trim();
            if (cep.replace(/\D/g, '').length === 8) {
                fillAddressByCep(cep);
            }
        });

        reservadoCheckbox.addEventListener('change', toggleDataReservaField);
        clientSearchInput.addEventListener('input', filterClients);

        /**
         * Preenche o dropdown 'Representante' com utilizadores ativos do tipo 'representante'.
         */
        function populateRepresentantes() {
            const users = loadUsers();
            const representantes = users.filter(user => user.userType === 'representante' && user.userActive);

            representanteSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione um Representante (opcional)';
            representanteSelect.appendChild(defaultOption);

            representantes.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep.userName;
                option.textContent = rep.userName;
                representanteSelect.appendChild(option);
            });
        }


        // --- Funções Específicas de Utilizadores ---
        /**
         * Carrega utilizadores do localStorage. Se não houver utilizadores, inicializa com um utilizador padrão.
         * @returns {Array<Object>} Um array de objetos de utilizador.
         */
        function loadUsers() {
            try {
                let users = JSON.parse(localStorage.getItem('users'));
                if (!users || users.length === 0) {
                    // Inicializa com Rogério se nenhum utilizador for encontrado
                    users = [{
                        id: 1,
                        userName: "Rogerio",
                        userEmail: "rogerio.belmiro@atlantica.com.br",
                        userPhone: "11964145572",
                        userType: "administrador",
                        userPassword: "1234", // Armazenando senha para fins de demonstração
                        userActive: true,
                        userGerente: ""
                    }];
                    localStorage.setItem('users', JSON.stringify(users)); // Salva o utilizador inicializado
                } else {
                    // Verifica se Rogério já existe para evitar duplicatas em carregamentos subsequentes
                    const rogerioExists = users.some(user => user.userEmail === "rogerio.belmiro@atlantica.com.br");
                    if (!rogerioExists) {
                        const newId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
                        users.push({
                            id: newId,
                            userName: "Rogerio",
                            userEmail: "rogerio.belmiro@atlantica.com.br",
                            userPhone: "11964145572",
                            userType: "administrador",
                            userPassword: "1234",
                            userActive: true,
                            userGerente: ""
                        });
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                }
                return users;
            } catch (e) {
                console.error("Erro ao carregar utilizadores do localStorage:", e);
                return [];
            }
        }

        /**
         * Salva utilizadores no localStorage.
         * @param {Array<Object>} users - Um array de objetos de utilizador a ser salvo.
         */
        function saveUsers(users) {
            try {
                localStorage.setItem('users', JSON.stringify(users));
            } catch (e) {
                console.error("Erro ao salvar utilizadores no localStorage:", e);
                showMessage("Erro ao salvar dados do utilizador no navegador.", "error");
            }
            populateRepresentantes();
            populateGerentes();
        }

        /**
         * Alterna a visibilidade dos campos Gerente e Representantes com base no tipo de utilizador selecionado.
         */
        function toggleUserSpecificFields() {
            // Redefine a visibilidade e limpa os valores dos campos específicos
            gerenteContainer.classList.add('hidden');
            userGerenteSelect.removeAttribute('required');
            userGerenteSelect.value = '';

            representantesContainer.classList.add('hidden'); // Oculta o contentor de representantes
            userRepresentantesDisplay.innerHTML = '';
            userRepresentantesDisplay.classList.remove('text-gray-500', 'italic');

            if (userTypeSelect.value === 'representante') {
                gerenteContainer.classList.remove('hidden');
                userGerenteSelect.setAttribute('required', 'true');
                populateGerentes();
            } else if (userTypeSelect.value === 'gerente') {
                // Para o tipo "gerente", o campo de representantes é apenas de exibição na tabela,
                // não é um campo de entrada no formulário.
                // A exibição no formulário será acionada por editUser e updateRepresentativesDisplayForManager.
            }
        }

        /**
         * Preenche o dropdown 'Gerente' com utilizadores ativos do tipo 'gerente'.
         */
        function populateGerentes() {
            const users = loadUsers();
            const gerentes = users.filter(user => user.userType === 'gerente' && user.userActive);

            userGerenteSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione um Gerente';
            userGerenteSelect.appendChild(defaultOption);

            gerentes.forEach(ger => {
                const option = document.createElement('option');
                option.value = ger.userName;
                option.textContent = ger.userName;
                userGerenteSelect.appendChild(option);
            });
        }

        /**
         * Atualiza a área de exibição para representantes atribuídos a um determinado gerente.
         * @param {string} managerName - O nome do gerente para o qual encontrar representantes.
         */
        function updateRepresentativesDisplayForManager(managerName) {
            const users = loadUsers();
            const assignedRepresentatives = users.filter(user =>
                user.userType === 'representante' &&
                user.userActive &&
                user.userGerente === managerName
            ).map(user => user.userName);

            userRepresentantesDisplay.innerHTML = '';
            userRepresentantesDisplay.classList.remove('text-gray-500', 'italic');

            if (assignedRepresentatives.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside text-gray-700';
                assignedRepresentatives.forEach(repName => {
                    const li = document.createElement('li');
                    li.textContent = repName;
                    ul.appendChild(li);
                });
                userRepresentantesDisplay.appendChild(ul);
                representantesContainer.classList.remove('hidden');
            } else {
                userRepresentantesDisplay.textContent = 'Nenhum representante atribuído.';
                userRepresentantesDisplay.classList.add('text-gray-500', 'italic');
                representantesContainer.classList.remove('hidden');
            }
        }

        /**
         * Renderiza a tabela de utilizadores com os utilizadores fornecidos.
         * @param {Array<Object>} users - Um array de objetos de utilizador para exibir.
         */
        function renderUsers(users) {
            userTableBody.innerHTML = '';
            if (users.length === 0) {
                const noUsersRow = `
                    <tr>
                        <td colspan="9" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                            Nenhum utilizador cadastrado.
                        </td>
                    </tr>
                `;
                userTableBody.innerHTML = noUsersRow;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.id = `user-${user.id}`;
                row.className = 'hover:bg-gray-50';

                // Determina o que exibir para 'Gerente' e 'Representantes'
                let gerenteDisplay = 'N/A';
                let representantesDisplay = 'N/A';

                if (user.userType === 'representante') {
                    gerenteDisplay = user.userGerente || 'N/A';
                } else if (user.userType === 'gerente') {
                    const allUsers = loadUsers();
                    const managerName = user.userName;
                    const associatedReps = allUsers.filter(rep =>
                        rep.userType === 'representante' &&
                        rep.userGerente === managerName
                    ).map(rep => rep.userName);
                    representantesDisplay = (associatedReps.length > 0) ? associatedReps.join(', ') : 'N/A';
                }


                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.userName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.userEmail}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatPhone(user.userPhone || '') || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.userType || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gerenteDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${representantesDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.userActive ? 'Sim' : 'Não'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-center space-x-2">
                        <button type="button" onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 p-2 rounded-full hover:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button type="button" onclick="showConfirmModal(${user.id}, 'user')" class="text-red-600 hover:text-red-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 p-2 rounded-full hover:bg-red-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                userTableBody.appendChild(row);
            });
        }

        userForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const userName = userNameInput.value.trim();
            const userEmail = userEmailInput.value.trim();
            const userPhone = userPhoneInput.value.trim();
            const userType = userTypeSelect.value;
            const userPassword = userPasswordInput.value;
            const userActive = userActiveCheckbox.checked;

            let userGerente = '';

            if (userType === 'representante') {
                userGerente = userGerenteSelect.value.trim();
                if (!userGerente) {
                    showMessage('Para Representantes, o campo Gerente é obrigatório.', 'error');
                    return;
                }
            }


            if (!userName || !userEmail || !userType || !userPassword) {
                showMessage('Nome, Email, Tipo de Utilizador e Senha são obrigatórios.', 'error');
                return;
            }

            let users = loadUsers();
            users = users.filter(user => user.userEmail !== "rogerio.belmiro@atlantica.com.br");


            if (editingUserId !== null) {
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex > -1) {
                    const emailExists = users.some(u => u.userEmail === userEmail && u.id !== editingUserId);
                    if (emailExists) {
                        showMessage('Erro: Este email já está cadastrado para outro utilizador.', 'error');
                        return;
                    }

                    users[userIndex] = {
                        ...users[userIndex],
                        userName,
                        userEmail,
                        userPhone: userPhone.replace(/\D/g, ''),
                        userType,
                        userPassword: userPassword,
                        userActive,
                        userGerente: userGerente,
                    };
                    showMessage('Utilizador atualizado com sucesso!', 'success');
                }
            } else {
                const emailExists = users.some(u => u.userEmail === userEmail);
                if (emailExists) {
                    showMessage('Erro: Este email já está cadastrado.', 'error');
                    return;
                }

                const newId = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
                const newUser = {
                    id: newId,
                    userName,
                    userEmail,
                    userPhone: userPhone.replace(/\D/g, ''),
                    userType,
                    userPassword: userPassword,
                    userActive,
                    userGerente: userGerente,
                };
                users.push(newUser);
                showMessage('Utilizador cadastrado com sucesso!', 'success');
            }

            saveUsers(users);
            filterUsers();
            userForm.reset();
            editingUserId = null;
            saveUserButton.textContent = 'Cadastrar Utilizador';
            cancelUserEditButton.classList.add('hidden');
            toggleUserSpecificFields();
        });

        window.editUser = function(id) {
            const users = loadUsers();
            const userToEdit = users.find(user => user.id === id);

            if (userToEdit) {
                userNameInput.value = userToEdit.userName || '';
                userEmailInput.value = userToEdit.userEmail || '';
                userPhoneInput.value = formatPhone(userToEdit.userPhone || '');
                userTypeSelect.value = userToEdit.userType || '';
                userPasswordInput.value = userToEdit.userPassword || '';
                userActiveCheckbox.checked = userToEdit.userActive || false;
                
                populateGerentes();
                toggleUserSpecificFields();

                if (userToEdit.userType === 'representante') {
                    userGerenteSelect.value = userToEdit.userGerente || '';
                } else if (userToEdit.userType === 'gerente') {
                    updateRepresentativesDisplayForManager(userToEdit.userName);
                }
                
                editingUserId = id;
                saveUserButton.textContent = 'Guardar Alterações';
                cancelUserEditButton.classList.remove('hidden');
                showMessage('A editar utilizador ID: ' + id, 'info');
            }
        };

        function deleteUser(id) {
            let users = loadUsers();
            const deletedUser = users.find(user => user.id === id);
            users = users.filter(user => user.id !== id);
            saveUsers(users);
            showMessage('Utilizador excluído com sucesso!', 'success');
            
            let changesMadeToOtherUsers = false;

            if (deletedUser && deletedUser.userType === 'gerente') {
                let currentUsers = loadUsers();
                currentUsers.forEach(user => {
                    if (user.userType === 'representante' && user.userGerente === deletedUser.userName) {
                        user.userGerente = '';
                        changesMadeToOtherUsers = true;
                    }
                });
                if (changesMadeToOtherUsers) {
                    saveUsers(currentUsers);
                }
            }

            filterUsers();

            if (editingUserId === id) {
                userForm.reset();
                editingUserId = null;
                saveUserButton.textContent = 'Cadastrar Utilizador';
                cancelUserEditButton.classList.add('hidden');
                toggleUserSpecificFields();
            }
        }

        cancelUserEditButton.addEventListener('click', () => {
            userForm.reset();
            editingUserId = null;
            saveUserButton.textContent = 'Cadastrar Utilizador';
            cancelUserEditButton.classList.add('hidden');
            showMessage('Edição de utilizador cancelada.', 'info');
            toggleUserSpecificFields();
        });

        userPhoneInput.addEventListener('input', (event) => {
            event.target.value = formatPhone(event.target.value);
        });

        function filterUsers() {
            const searchTerm = userSearchInput.value.trim().toLowerCase();
            let users = loadUsers();

            if (searchTerm === '') {
                renderUsers(users);
                return;
            }

            const filteredUsers = users.filter(user => {
                const userName = (user.userName || '').toLowerCase();
                const userEmail = (user.userEmail || '').toLowerCase();
                const userPhone = (user.userPhone || '').toLowerCase();
                const userType = (user.userType || '').toLowerCase();
                const userGerente = (user.userGerente || '').toLowerCase();
                
                let userRepresentantesString = '';
                if (user.userType === 'gerente') {
                    const allUsers = loadUsers();
                    const userRepresentantesList = allUsers.filter(rep =>
                        rep.userType === 'representante' &&
                        rep.userGerente === user.userName
                    ).map(rep => rep.userName.toLowerCase());
                    userRepresentantesString = userRepresentantesList.join(', ');
                }


                return userName.includes(searchTerm) ||
                       userEmail.includes(searchTerm) ||
                       userPhone.includes(searchTerm.replace(/\D/g, '')) ||
                       userType.includes(searchTerm) ||
                       userGerente.includes(searchTerm) ||
                       userRepresentantesString.includes(searchTerm);
            });

            renderUsers(filteredUsers);
        }

        userSearchInput.addEventListener('input', filterUsers);
        userTypeSelect.addEventListener('change', toggleUserSpecificFields);


        // Carregamento inicial e exibição de abas
        document.addEventListener('DOMContentLoaded', () => {
            showTab('clients');
            filterClients();
            filterUsers();
            toggleDataReservaField();
            // toggleUserSpecificFields() é chamado por showTab('users') para a secção de utilizadores
        });
    </script>
</body>
</html>
